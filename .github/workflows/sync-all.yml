name: Sync GitHub repos to Gitee

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo (for repos.txt)
        uses: actions/checkout@v3

      - name: Setup SSH for Gitee (debug)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITEE_PRIVATE_KEY }}" | base64 --decode > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
      
          echo "=== Private key head ==="
          head -n 3 ~/.ssh/id_rsa
          echo "=== Private key tail ==="
          tail -n 3 ~/.ssh/id_rsa
          
          > ~/.ssh/known_hosts
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts
          echo "=== Known hosts content ==="
          cat ~/.ssh/known_hosts
      
          ssh -vvv -T git@gitee.com || true  # å…è®¸å¤±è´¥ï¼Œä¸å½±å“åç»­æ­¥éª¤



      - name: Sync repos from repos.txt
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
         while read -r repo; do
            echo "ğŸ”„ Syncing $repo ..."
          
            # âœ… è‡ªåŠ¨åˆ›å»º Gitee ä»“åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            echo "ğŸ” Checking if Gitee repo exists..."
            repo_check_url="https://gitee.com/api/v5/repos/fan-ruibo/${repo}?access_token=${GITEE_TOKEN}"
            repo_create_url="https://gitee.com/api/v5/user/repos"
          
            if ! curl -s "${repo_check_url}" | grep -q "\"name\":"; then
              echo "ğŸ› ï¸ Gitee repo does not exist. Creating..."
              curl -s -X POST "${repo_create_url}" \
                -H "Content-Type: application/json" \
                -d "{
                  \"access_token\": \"${GITEE_TOKEN}\",
                  \"name\": \"${repo}\",
                  \"private\": false,
                  \"auto_init\": false
                }" > /dev/null
          
              echo "âœ… Gitee repo '${repo}' created"
              sleep 3  # ç­‰å¾…åˆ›å»ºå®Œæˆ
            else
              echo "âœ… Gitee repo '${repo}' already exists"
            fi
          
            rm -rf "$repo.git"
          
            # å…‹éš†è£¸ä»“åº“ï¼Œä½¿ç”¨ PAT è®¤è¯
            git clone --bare "https://ghp_${GH_PAT}@github.com/StarryCode-Lang/${repo}.git" "$repo.git"
            if [ ! -d "$repo.git" ]; then
              echo "âŒ Clone failed for $repo"
              continue
            fi
          
            cd "$repo.git"
          
            # æ·»åŠ æˆ–æ›´æ–° gitee è¿œç¨‹ä»“åº“ï¼ˆSSHï¼‰
            if git remote | grep -q '^gitee$'; then
              git remote set-url gitee "git@gitee.com:fan-ruibo/${repo}.git"
            else
              git remote add gitee "git@gitee.com:fan-ruibo/${repo}.git"
            fi
          
            # æ¨é€é•œåƒ
            git push --mirror gitee || echo "âš ï¸ Push to Gitee failed for $repo"
          
            cd ..
          done < repos.txt
